import tweepy
from textblob import TextBlob
import json
import sys
import pymongo

TWITTER_APP_KEY = ""
TWITTER_APP_SECRET = ""
TWITTER_KEY = ""
TWITTER_SECRET = ""

TRACK_TERMS = ["labour","conservatives"]

def key_terms(tweet): # Function that identifies key terms from tweets pulled in
    TRACK_TERMS = ["labour", "conservatives"]
    x = tweet.split(' ')
    for i in x:
        if i in TRACK_TERMS:
            return i



class KubrickListener(tweepy.StreamListener):

    def on_connect(self):

        # Called initially to connect to the Streaming API

        print("You are now connected to the streaming API.")



    def on_error(self, status_code):

        # On error - if an error occurs, display the error / status code

        print('An Error has occured: ' + repr(status_code))

        return False

    def on_data(self, status):











        try:



            connection = pymongo.MongoClient()

            db = connection.test4           # to connect to mongo





            td = json.loads(status)  # load tweet in json dictionary format

            text = td['text']    # set the tweet to variable 'text'

            # to insert polarity etc into mongo

            td['polarity'] = TextBlob(text).sentiment.polarity   # calculates polarity of tweet and adds column to mongo

            td['subjectivity'] = TextBlob(text).sentiment.subjectivity  # "" subjectivity ""

            td['keyTerms'] = key_terms(text)



            db.test123.insert(td)  # Insert into mongo ...Need to change name of this collection...



            print '___: D___'

        except:



            print 'error. sorry'



    def on_error(self, status_code):

        if status_code == 420:

            #  returning False in on_data disconnects the stream

            return False





auth = tweepy.OAuthHandler(TWITTER_APP_KEY, TWITTER_APP_SECRET)

auth.set_access_token(TWITTER_KEY, TWITTER_SECRET)

api = tweepy.API(auth)



KL = KubrickListener()

stream = tweepy.Stream(auth=api.auth, listener=KL)

stream.filter(track=TRACK_TERMS)
